<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TextShield</title>
    <link rel="icon" href="icon.png" type="image/png"> <!-- Link to the PNG icon -->
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #1a1a1a;
            color: #ffffff;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: auto;
            text-align: center;
        }

        input[type="text"] {
            width: calc(100% - 20px);
            padding: 10px;
            margin-bottom: 10px;
            border: none;
            border-radius: 5px;
            background-color: #333;
            color: #fff;
        }

        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            background-color: #444;
            color: white;
            cursor: pointer;
        }

        button:hover {
            background-color: #555;
        }

        .output-container {
            margin-top: 20px;
            text-align: center;
        }

        .output-label {
            font-size: 1.2em;
            white-space: pre-line; /* Preserve line breaks */
            word-break: break-word; /* Break long words if necessary */
            text-align: center;
            display: inline-block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>TextShield</h1>
        <input id="textInput" type="text" placeholder="Enter text to encrypt or decrypt">
        <input id="keyInput" type="text" placeholder="Enter encryption key">
        
        <button onclick="encryptText()">Encrypt</button>
        <button onclick="decryptText()">Decrypt</button>
        
        <div class="output-container">
            <label id="outputLabel" class="output-label">...</label>
            <div>
                <button id="copyButton" onclick="copyToClipboard()">Copy</button>
            </div>
        </div>
    </div>

    <script>
        async function getKeyFromPassword(password) {
            const encoder = new TextEncoder();
            const keyMaterial = await crypto.subtle.importKey(
                "raw",
                encoder.encode(password),
                "PBKDF2",
                false,
                ["deriveKey"]
            );

            return crypto.subtle.deriveKey(
                {
                    name: "PBKDF2",
                    salt: encoder.encode("unique-salt"), // Should use a unique salt per user
                    iterations: 100000,
                    hash: "SHA-256"
                },
                keyMaterial,
                { name: "AES-GCM", length: 256 },
                false,
                ["encrypt", "decrypt"]
            );
        }

        async function encryptText() {
            const text = document.getElementById('textInput').value;
            const password = document.getElementById('keyInput').value;

            if (text && password) {
                const key = await getKeyFromPassword(password);
                const iv = crypto.getRandomValues(new Uint8Array(12)); // 12 bytes for AES-GCM

                const encryptedContent = await crypto.subtle.encrypt(
                    { name: "AES-GCM", iv: iv },
                    key,
                    new TextEncoder().encode(text)
                );

                const encryptedBytes = new Uint8Array(encryptedContent);
                const encryptedText = btoa(String.fromCharCode(...iv) + String.fromCharCode(...encryptedBytes));

                document.getElementById('outputLabel').innerText = formatOutput(encryptedText);
            } else {
                document.getElementById('outputLabel').innerText = '...';
            }
        }

        async function decryptText() {
            const encryptedText = document.getElementById('textInput').value;
            const password = document.getElementById('keyInput').value;

            if (encryptedText && password) {
                const key = await getKeyFromPassword(password);
                const encryptedData = atob(encryptedText);
                
                const iv = new Uint8Array(encryptedData.slice(0, 12).split('').map(c => c.charCodeAt(0)));
                const encryptedBytes = new Uint8Array(encryptedData.slice(12).split('').map(c => c.charCodeAt(0)));

                try {
                    const decryptedContent = await crypto.subtle.decrypt(
                        { name: "AES-GCM", iv: iv },
                        key,
                        encryptedBytes
                    );

                    document.getElementById('outputLabel').innerText = formatOutput(new TextDecoder().decode(decryptedContent));
                } catch (e) {
                    document.getElementById('outputLabel').innerText = "!!! Decryption failed: Invalid Input. !!!";
                }
            } else {
                document.getElementById('outputLabel').innerText = '...';
            }
        }

        function copyToClipboard() { 
            const outputLabel = document.getElementById('outputLabel').innerText;
            navigator.clipboard.writeText(outputLabel.replace(/\n/g, '')).then(() => {
                alert('Copied to clipboard!');
            });
        }

        function formatOutput(text) {
            // Insert a newline every 30 characters
            return text.match(/.{1,30}/g).join('\n');
        }
    </script>
</body>
</html>
